<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Snapshot Plugin - Sandpolis Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Snapshot Plugin";
    var mkdocs_page_input_path = "specification/com.sandpolis.plugin.snapshot.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sandpolis Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/getting_started/">Getting Started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/client/gui/">Using the desktop client</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/client/terminal/">Using the terminal client</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Specification</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">General</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../module.md">Module</a>
                </li>
                <li class="toctree-l2"><a class="" href="../instance.md">Instance</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Instances</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../agent.md">Agent</a>
                </li>
                <li class="toctree-l2"><a class="" href="../server.md">Server</a>
                </li>
                <li class="toctree-l2"><a class="" href="../distagent.md">Distagent</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Messages</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../clientserver.md">Client/Server</a>
                </li>
                <li class="toctree-l2"><a class="" href="../serveragent.md">Server/Agent</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Plugins</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../plugins/desktop.md">Desktop Plugin</a>
                </li>
                <li class="toctree-l2"><a class="" href="../plugins/device.md">Device Plugin</a>
                </li>
                <li class="toctree-l2"><a class="" href="../plugins/filesystem.md">Filesystem Plugin</a>
                </li>
                <li class="toctree-l2"><a class="" href="../plugins/shell.md">Shell Plugin</a>
                </li>
                <li class="toctree-l2"><a class="" href="../plugins/snapshot.md">Snapshot Plugin</a>
                </li>
                <li class="toctree-l2"><a class="" href="../plugins/update.md">Update Plugin</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Implementation Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="" href="../../application/client.md">Client</a>
                    </li>
                    <li class="toctree-l1"><a class="" href="../../application/server.md">Server</a>
                    </li>
                    <li class="toctree-l1"><a class="" href="../../application/agent.md">Agent</a>
                    </li>
                    <li class="toctree-l1"><a class="" href="../../application/network.md">Networking</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sandpolis Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Snapshot Plugin</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="snapshot-plugin">Snapshot Plugin</h1>
<p>The snapshot plugin gives agents the ability to take and apply snapshots, even
on filesystems that don't natively support snapshots.</p>
<h2 id="block-based-snapshots">Block-based snapshots</h2>
<p>The target device is divided into blocks of variable size (power of 2 only).
Each block has a corresponding block hash which is the murmur3 128-bit hash of
its content.</p>
<h2 id="file-based-snapshots">File-based snapshots</h2>
<h2 id="partition-size-considerations">Partition size considerations</h2>
<h3 id="on-premise-server">On-premise Server</h3>
<p>(1 TiB) = (100 MiB / s) * t</p>
<p>t = 1000 s ~ 16 minutes</p>
<h3 id="off-premise-server">Off-premise Server</h3>
<p>(1 TiB) = (1 MiB / s) * t</p>
<p>t = 100000 s ~ 27 hours</p>
<h2 id="server">Server</h2>
<p>The server is responsible for storing snapshot data and uploading/downloading it
to/from agents.</p>
<h3 id="snapshot-format">Snapshot format</h3>
<p>Snapshot contents are stored in QEMU qcow2 files on the server. This format is
mature and supports useful features like compression and encryption.</p>
<h2 id="boot-agent">Boot Agent</h2>
<p>All snapshot read/write operations are run from a boot agent rather than the
regular agent. This ensures snapshots are perfectly consistent, but implies some
amount of downtime during the operation.</p>
<h4 id="create-snapshot">Create Snapshot</h4>
<p>If there exist no previous snapshots, the boot agent first determines the
appropriate block size for the disk. The agent may take into account the size of
the disk or the erase-block size of an SSD, but the block size must be a power
of two.</p>
<p>If allowed, the boot agent will wipe the disk's free space before continuing.
This can significantly decrease the size of the resulting snapshot because empty
blocks are omitted.</p>
<p>If there exists a previous snapshot for the disk, the boot agent receives a
stream of block hashes. A single worker thread reads blocks from the disk and
compares their hashes against the block hashes retrieved from the server. If the
hashes do not match, the block is passed into a send queue to be egressed to the
server.</p>
<h4 id="apply-snapshot">Apply Snapshot</h4>
<p>If there exists a previous snapshot for the disk, the boot agent initiates a
stream of block hashes. A single worker thread reads blocks from the disk and
passes their hashes into a send queue to be egressed to the server.</p>
<p>Simultaneously, the boot agent receives a stream of block data which are placed
into a write queue to be written to the device.</p>
<h2 id="snapshot-messages">Snapshot Messages</h2>
<table>
<thead>
<tr>
<th>Message</th>
<th>Sources</th>
<th>Destinations</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RQ_CreateSnapshot</td>
<td><code>client</code></td>
<td><code>server</code></td>
<td>Create a new snapshot on a target agent</td>
</tr>
<tr>
<td>RQ_ApplySnapshot</td>
<td><code>client</code></td>
<td><code>server</code></td>
<td>Apply an existing snapshot on a target agent</td>
</tr>
<tr>
<td>RQ_SnapshotStream</td>
<td><code>server</code></td>
<td><code>agent</code></td>
<td>Create a new snapshot stream</td>
</tr>
<tr>
<td>EV_SnapshotDataBlock</td>
<td><code>server</code>, <code>agent</code></td>
<td><code>server</code>, <code>agent</code></td>
<td>An event containing compressed snapshot data</td>
</tr>
<tr>
<td>EV_SnapshotHashBlock</td>
<td><code>server</code>, <code>agent</code></td>
<td><code>server</code>, <code>agent</code></td>
<td>An event containing one or more contiguous block hashes</td>
</tr>
</tbody>
</table>
<h3 id="rq_createsnapshot">RQ_CreateSnapshot</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Requirements</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>agent_uuid</td>
<td>string</td>
<td></td>
<td>The target agent's UUID</td>
</tr>
<tr>
<td>partition_uuid</td>
<td>string</td>
<td></td>
<td>The target partition's UUID</td>
</tr>
</tbody>
</table>
<h3 id="rq_applysnapshot">RQ_ApplySnapshot</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Requirements</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>agent_uuid</td>
<td>string</td>
<td></td>
<td>The target agent's UUID</td>
</tr>
<tr>
<td>partition_uuid</td>
<td>string</td>
<td></td>
<td>The target partition's UUID</td>
</tr>
<tr>
<td>snapshot_uuid</td>
<td>string</td>
<td></td>
<td>The snapshot's UUID</td>
</tr>
</tbody>
</table>
<h3 id="rq_snapshotstream">RQ_SnapshotStream</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Requirements</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>stream_id</td>
<td>int32</td>
<td></td>
<td>The stream's ID</td>
</tr>
<tr>
<td>operation</td>
<td>string</td>
<td>"create" or "apply"</td>
<td>The snapshot operation type</td>
</tr>
<tr>
<td>partition_uuid</td>
<td>string</td>
<td></td>
<td>The target partition uuid</td>
</tr>
<tr>
<td>block_size</td>
<td>int32</td>
<td></td>
<td>The block size in bytes</td>
</tr>
</tbody>
</table>
<h3 id="ev_snapshotdatablock">EV_SnapshotDataBlock</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Requirements</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>offset</td>
<td>int64</td>
<td></td>
<td>The block's offset</td>
</tr>
<tr>
<td>data</td>
<td>bytes</td>
<td></td>
<td>The block's contents compressed with zlib</td>
</tr>
</tbody>
</table>
<h3 id="ev_snapshothashblock">EV_SnapshotHashBlock</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Requirements</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>offset</td>
<td>int64</td>
<td></td>
<td>The offset of the block that the first hash corresponds</td>
</tr>
<tr>
<td>hash</td>
<td>repeated bytes</td>
<td></td>
<td>A list of consecutive block hashes</td>
</tr>
</tbody>
</table>
<h2 id="permissions-list">Permissions list</h2>
<table>
<thead>
<tr>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>agent.snapshot.create</code></td>
<td>Rights create new snapshots of agent disks</td>
</tr>
<tr>
<td><code>agent.snapshot.apply</code></td>
<td>Rights apply existing snapshots to agent disks</td>
</tr>
<tr>
<td><code>server.snapshot.list</code></td>
<td>Rights to list existing snapshots stored by the server</td>
</tr>
</tbody>
</table>
<h2 id="configuration">Configuration</h2>
<table>
<thead>
<tr>
<th>Property</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>s7s.snapshot.storage.provider</code></td>
<td><em>filesystem</em></td>
<td>The storage provider to use</td>
</tr>
<tr>
<td><code>s7s.snapshot.storage.filesystem.path</code></td>
<td></td>
<td>The filesystem path</td>
</tr>
</tbody>
</table>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
